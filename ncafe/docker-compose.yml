services:
  # ─── Spring Boot Backend ─────────────────────────────────────────────────────
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: danhee-final-backend-v1
    restart: always
    ports:
      # .env 파일의 BACKEND_PORT로 호스트 포트 변경 가능 (기본값: 8080)
      - "8022:8022"
    environment:
      # 외부 PostgreSQL DB 연결 정보 (application.properties를 환경변수로 오버라이드)
      SERVER_PORT: 8022
      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL:-jdbc:postgresql://db:5432/ncafedb}
      SPRING_DATASOURCE_USERNAME: ${SPRING_DATASOURCE_USERNAME:-ncafe}
      SPRING_DATASOURCE_PASSWORD: ${SPRING_DATASOURCE_PASSWORD:-danhee123}
    volumes:
      # 업로드된 파일을 호스트와 공유 (컨테이너 재시작 시 데이터 유지)
      - /home/danheepark/www/ncafe/ncafe/upload:/app/upload
    networks:
      - ncafe-net
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8022/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ─── Next.js Frontend ────────────────────────────────────────────────────────
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: danhee-final-frontend-v1
    restart: always
    ports:
      # .env 파일의 FRONTEND_PORT로 호스트 포트 변경 가능 (기본값: 3022)
      - "3022:3000"
    environment:
      NODE_ENV: production
      # 컨테이너 내부에서 backend 서비스로 프록시
      BACKEND_URL: http://backend:8022
    networks:
      - ncafe-net
    depends_on:
      backend:
        condition: service_started

  # db 서비스 추가 
  db:
    image: postgres:15
    container_name: danhee-db
    restart: always
    environment:
      POSTGRES_DB: ncafedb
      POSTGRES_USER: ncafe
      POSTGRES_PASSWORD: danhee123
    ports:
      - "${DB_PORT:-5432}:5432"
    volumes:
      - ./postgres_data:/var/lib/postgresql/data
    networks:
      - ncafe-net

networks:
  ncafe-net:
    driver: bridge